# RAG系统设计方案

## 1. 系统概述

本RAG（检索增强生成）系统基于混合检索策略，结合稀疏检索（BM25）和稠密检索（语义embedding）进行高效文档检索，并使用大型语言模型进行生成。

### 1.1 系统架构

系统分为以下几个主要模块：

1. **文档处理模块**：负责文档的加载、处理和分块
2. **索引模块**：包括BM25索引和向量索引的创建和管理
3. **检索模块**：实现混合检索策略，结合BM25和向量检索结果
4. **生成模块**：将用户问题和检索结果输入大模型，生成回答
5. **数据库模块**：提供对Elasticsearch和Milvus的支持
6. **增量更新模块**：支持知识库的增量更新

### 1.2 技术栈

- **检索**：
  - 稀疏检索：Rank-BM25
  - 稠密检索：BGE-M3 (使用Ollama API)
  
- **生成**：
  - Qwen3-32B (使用本地VLLM API)
  
- **数据库**：
  - Elasticsearch：用于BM25检索
  - Milvus：用于向量检索
  
- **其他库**：
  - LangChain：为文档处理、检索和生成提供集成框架
  - FAISS：作为向量检索的备选方案

## 2. 详细设计

### 2.1 文档处理模块

文档处理模块负责将各种格式的文档（如TXT、PDF、DOCX等）转换为适合检索的文本块。

核心功能：
- 支持多种文档格式加载
- 文档分块(chunking)
- 元数据提取和管理

### 2.2 索引模块

#### 2.2.1 BM25索引

使用Rank-BM25库或Elasticsearch创建基于关键词的索引。

#### 2.2.2 向量索引

使用BGE-M3模型通过Ollama API生成文档嵌入，并存储在Milvus或FAISS中。

### 2.3 检索模块

实现混合检索策略，包括：
- BM25检索：基于关键词匹配
- 向量检索：基于语义相似度
- 结果融合：通过重排序或加权组合融合两种检索结果

### 2.4 生成模块

将用户问题和检索到的文档传递给Qwen3-32B模型，生成回答。

支持的功能：
- 简单提示模板
- 支持迭代检索（根据LLM反馈进行多轮检索）

### 2.5 数据库模块

#### 2.5.1 Elasticsearch
- 管理BM25索引
- 提供全文检索功能

#### 2.5.2 Milvus
- 管理向量索引
- 提供高效的ANN(近似最近邻)搜索

### 2.6 增量更新模块

- 支持增量添加新文档到知识库
- 避免重新索引整个知识库

## 3. 部署与使用

### 3.1 环境配置

- Python 3.8+
- 所需依赖库
- Elasticsearch和Milvus配置

### 3.2 知识库初始化

- 创建文档文件夹
- 批量处理和索引文档

### 3.3 查询流程

1. 用户提问
2. 混合检索相关文档
3. 生成回答

## 4. 后续优化方向

- 检索效果评估和优化
- 生成质量改进
- 支持更多文档格式
- 用户反馈机制